<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1><%= isEdit ? 'Edit Locker' : 'Create Locker' %></h1>
      <a href="/admin/lockers" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back to List
      </a>
    </div>

    <div class="card">
      <div class="card-body">
        <form id="locker-form">
          <div class="mb-3">
            <label for="number" class="form-label">Locker Number <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="number" name="number" required placeholder="e.g., A001">
            <div class="form-text">Unique identifier for the locker</div>
          </div>
          
          <div class="mb-3">
            <label for="size" class="form-label">Size <span class="text-danger">*</span></label>
            <select class="form-select" id="size" name="size" required>
              <option value="">Select a size</option>
              <option value="small">Small</option>
              <option value="medium">Medium</option>
              <option value="large">Large</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="price" class="form-label">Price (â‚¬) <span class="text-danger">*</span></label>
            <input type="number" class="form-control" id="price" name="price" required min="0" step="0.01" placeholder="0.00">
            <div class="form-text">Price per reservation period</div>
          </div>
          
          <div class="mb-3">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status">
              <option value="available">Available</option>
              <option value="reserved">Reserved</option>
              <option value="maintenance">Maintenance</option>
            </select>
          </div>
          
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-circle me-2"></i><%= isEdit ? 'Update Locker' : 'Create Locker' %>
            </button>
            <a href="/admin/lockers" class="btn btn-secondary">Cancel</a>
          </div>
        </form>
        
        <div id="alert-container" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  const token = getCookie('token');
  const isEdit = <%= isEdit ? 'true' : 'false' %>;
  const lockerId = '<%= typeof lockerId !== "undefined" ? lockerId : "" %>';
  const form = document.getElementById('locker-form');
  const alertContainer = document.getElementById('alert-container');

  // If editing, load existing locker data
  if (isEdit && lockerId) {
    try {
      const res = await fetch(`/api/lockers/${lockerId}`);
      if (res.ok) {
        const locker = await res.json();
        form.elements['number'].value = locker.number;
        form.elements['size'].value = locker.size;
        form.elements['status'].value = locker.status;
        form.elements['price'].value = locker.price;
      } else {
        alert('Failed to load locker data');
      }
    } catch (err) {
      console.error('Failed to fetch locker data:', err);
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
      const res = await fetch(isEdit ? `/api/lockers/${lockerId}` : '/api/lockers', {
        method: isEdit ? 'PUT' : 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        alert('Locker saved successfully');
        window.location.href = '/admin/lockers';
      } else {
        const error = await res.json();
        alert(error.message || 'Failed to save locker');
      }
    } catch (err) {
      console.error('Failed to save locker:', err);
      alert('Failed to save locker');
    }
  });
});
</script>
